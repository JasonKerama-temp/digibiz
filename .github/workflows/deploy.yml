name: Build iOS Cordova App (Manual Signing)

on:
  push:
    branches:
      - main

env:
  APP_NAME: "Digibiz"
  PROJECT_VERSION: 3080 
  TEAM_ID: Z6XW557ZX2 
  PROFILE_NAME: "Digibiz iOS"
  NODE_VERSION: 18

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Cordova CLI
        run: npm install -g cordova@11

      # Clean rebuild for manual signing
      - name: Prepare iOS platform (Clean rebuild)
        run: |
          echo "ğŸ”„ Removing old iOS platform..."
          rm -rf platforms/ios || true
          rm -rf www || true
          
          echo "ğŸ—ï¸  Building www directory..."
          npm run build || true
          
          echo "ğŸ“± Adding iOS platform..."
          cordova platform add ios@6.2.0
          
          echo "âœ… Setting execute permissions on cordova tools..."
          chmod -R +x platforms/ios/cordova

      # ğŸ”‘ Import Certificate (P12)
      - name: ğŸ”‘ Import iOS Certificate
        run: |
          echo "ğŸ“¦ Decoding and importing certificate..."
          echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 --decode > ios_cert.p12
          
          echo "ğŸ” Creating keychain..."
          security create-keychain -p "" build.keychain
          security list-keychains -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "" ~/Library/Keychains/build.keychain
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
          
          echo "âœ… Importing certificate to keychain..."
          security import ios_cert.p12 -k ~/Library/Keychains/build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          
          echo "âœ… Certificate imported successfully"

      # ğŸ“„ Install Provisioning Profile
      - name: ğŸ“„ Install Provisioning Profile
        run: |
          echo "ğŸ“ Creating provisioning profiles directory..."
          mkdir -p "~/Library/MobileDevice/Provisioning Profiles"
          
          echo "ğŸ“¥ Installing provisioning profile..."
          echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > "~/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision"
          
          echo "âœ… Provisioning profile installed"
          ls -la "~/Library/MobileDevice/Provisioning Profiles/"

      # ğŸ—ï¸ Build Archive with Manual Signing
      - name: ğŸ—ï¸  Build Xcode Archive
        run: |
          echo "ğŸ”¨ Building archive with manual signing..."
          mkdir -p output
          
          xcodebuild archive \
            -workspace "platforms/ios/${{ env.APP_NAME }}.xcworkspace" \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -derivedDataPath "output/derived" \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_REQUIRED="YES" \
            CODE_SIGN_IDENTITY="iPhone Developer" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="${{ env.TEAM_ID }}" \
            CURRENT_PROJECT_VERSION="${{ env.PROJECT_VERSION }}" \
            OTHER_CODE_SIGN_FLAGS="--keychain ~/Library/Keychains/build.keychain"
          
          echo "âœ… Archive created successfully"

      # ğŸ“¤ Export IPA
      - name: ğŸ“¤ Export IPA
        run: |
          echo "ğŸ“¦ Exporting IPA..."
          mkdir -p output/ipa
          
          xcodebuild -exportArchive \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "output/ipa/" \
            -allowProvisioningUpdates
          
          echo "âœ… IPA exported successfully"
          ls -lah output/ipa/

      # ğŸ“Š Verify build artifacts
      - name: ğŸ“Š Verify Build Artifacts
        run: |
          echo "ğŸ” Checking for IPA file..."
          if [ -f "output/ipa/"*.ipa ]; then
              echo "âœ… IPA file found:"
              ls -lah "output/ipa/"*.ipa
          else
              echo "âŒ No IPA file found!"
              exit 1
          fi

      # ğŸ§¹ Cleanup (Always run)
      - name: ğŸ§¹ Cleanup Sensitive Files
        if: always()
        run: |
          echo "ğŸ—‘ï¸  Cleaning up sensitive files..."
          security delete-keychain build.keychain || true
          rm -f ios_cert.p12 || true
          rm -rf "~/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision" || true
          echo "âœ… Cleanup complete"

      # ğŸ“¤ Upload Artifacts
      - name: ğŸ“¤ Upload IPA Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ github.run_number }}
          path: output/ipa/*.ipa
          retention-days: 30

      # ğŸ“ Upload Build Logs
      - name: ğŸ“ Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            output/derived/Logs/Build/*.log
            output/derived/Logs/*.log
          retention-days: 7
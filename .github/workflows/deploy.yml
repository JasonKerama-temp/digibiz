name: üöÄ Cordova iOS Production Build (FINAL FIX)

on:
  push:
    branches:
      - main

env:
  APP_NAME: "Digibiz"
  PROJECT_VERSION: 3080 
  TEAM_ID: Z6XW557ZX2 
  PROFILE_NAME: "Digibiz iOS"
  NODE_VERSION: 20
  IOS_PLATFORM_VERSION: 7.0.0 

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: üîç Checkout repository
        uses: actions/checkout@v4

      # --- 1. SETUP ---
      - name: üõ†Ô∏è Setup Node.js (v${{ env.NODE_VERSION }})
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Removed 'cache: npm' to prevent lock file dependency issues

      - name: üì¶ Install npm dependencies (Force fresh resolution)
        run: |
          # üõë CRITICAL FIX: Ensures a clean install without relying on npm ci or external cache
          npm cache clean --force
          rm -rf node_modules
          npm install

      # Force Install Cordova CLI 12 and verify
      - name: üîë Install Cordova CLI 12
        run: |
          echo "Installing Cordova 12 globally..."
          npm install -g cordova@12 --force
          cordova -v
          if ! cordova -v | grep -q "12"; then 
            echo "‚ùå Cordova 12 failed to install. Exiting."
            exit 1 
          fi

      # --- 2. PLATFORM & PLUGIN PREP ---
      - name: üßπ Clean CocoaPods Cache and Project Directories
        run: |
          # Keep the aggressive cleanup
          rm -rf platforms/ios || true
          rm -rf plugins || true
          rm -rf $HOME/Library/Caches/CocoaPods || true
          
      - name: üì± Add iOS platform v${{ env.IOS_PLATFORM_VERSION }}
        run: |
          echo "üîÑ Adding platform..."
          # üõë We must stop execution if the platform add fails
          cordova platform add ios@${{ env.IOS_PLATFORM_VERSION }}
          
      - name: üì¶ Install Plugins and Run Pod Install (Prepare)
        run: |
          echo "üîÑ Running Cordova prepare (and pod install)..."
          cordova prepare ios
          
      - name: üîç Verify Xcode Project Exists
        run: |
          PROJECT_PATH="platforms/ios/App.xcodeproj"
          if [ ! -d "$PROJECT_PATH" ]; then
            echo "‚ùå CRITICAL ERROR: Xcode project file was NOT created by the 'platform add' step."
            echo "Failed to create: $PROJECT_PATH"
            exit 1
          fi
          echo "‚úÖ Project found at $PROJECT_PATH. Proceeding to build."
          chmod -R +x platforms/ios/cordova

      # --- 3. SIGNING ASSET INSTALLATION ---
      # (All subsequent steps are unchanged)
      # üîë Import Certificate (P12)
      - name: üîë Import iOS Certificate
        run: |
          echo "üì¶ Importing certificate..."
          if [ -z "${{ secrets.IOS_CERTIFICATE_P12 }}" ]; then exit 1; fi
          if ! echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 -d > ios_cert.p12 2>/dev/null; then exit 1; fi
          security create-keychain -p "" build.keychain || true
          security list-keychains -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "" ~/Library/Keychains/build.keychain
          security import ios_cert.p12 -k ~/Library/Keychains/build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security default-keychain -s ~/Library/Keychains/build.keychain
          echo "‚úÖ Certificate imported."

      # üìÑ Install Provisioning Profile
      - name: üìÑ Install Provisioning Profile
        run: |
          echo "üìù Installing provisioning profile..."
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_DEST="$HOME/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision"
          if ! echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > "$PROFILE_DEST" 2>/dev/null; then 
            echo "‚ùå Failed to decode profile."
            exit 1
          fi
          echo "‚úÖ Profile installed."

      # --- 4. BUILD & EXPORT ---
      # üèóÔ∏è Build Archive with Manual Signing
      - name: üèóÔ∏è  Build Xcode Archive
        run: |  
          echo "üî® Building archive with manual signing..."
          mkdir -p output
          export KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain"
          
          # CRITICAL: Target 'App.xcodeproj' instead of .xcworkspace
          xcodebuild archive \
            -project "platforms/ios/App.xcodeproj" \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -derivedDataPath "output/derived" \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_REQUIRED="YES" \
            CODE_SIGN_IDENTITY="iPhone Developer" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="${{ env.TEAM_ID }}" \
            CURRENT_PROJECT_VERSION="${{ env.PROJECT_VERSION }}"
          
          echo "‚úÖ Archive created."
      # üì§ Export IPA
      - name: üì§ Export IPA
        run: |
          echo "üì¶ Exporting IPA..."
          mkdir -p output/ipa
          xcodebuild -exportArchive \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "output/ipa/" \
            -allowProvisioningUpdates
          echo "‚úÖ IPA exported."

      # --- 5. CLEANUP & ARTIFACTS ---
      # üßπ Cleanup Sensitive Files (Always run)
      - name: üßπ Cleanup Sensitive Files
        if: always()
        run: |
          echo "üóëÔ∏è Cleaning up sensitive files..."
          security delete-keychain build.keychain || true
          rm -f ios_cert.p12 || true
          rm -rf "$HOME/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision" || true
      
      # üì§ Upload IPA Artifact
      - name: üì§ Upload IPA Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-final-${{ github.run_number }}
          path: output/ipa/*.ipa
          retention-days: 30
name: Build iOS Cordova App (Manual Signing)

on:
  push:
    branches:
      - main

env:
  APP_NAME: "Digibiz"
  PROJECT_VERSION: 3080 
  TEAM_ID: Z6XW557ZX2 
  PROFILE_NAME: "Digibiz iOS"
  NODE_VERSION: 18

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Cordova CLI
        run: npm install -g cordova@11

      # Clean rebuild for manual signing
      - name: Prepare iOS platform (Clean rebuild)
        run: |
          echo "ğŸ”„ Removing old iOS platform..."
          rm -rf platforms/ios || true
          rm -rf plugins || true
          
          echo "ğŸ“± Adding iOS platform..."
          cordova platform add ios@6.2.0
          
          echo "ğŸ“¦ Installing Cordova plugins..."
          cordova prepare ios
          
          echo "âœ… Setting execute permissions on cordova tools..."
          chmod -R +x platforms/ios/cordova

      # ğŸ”‘ Import Certificate (P12)
      - name: ğŸ”‘ Import iOS Certificate
        run: |
          echo "ğŸ“¦ Preparing certificate for import..."
          
          # Check if the secret is provided
          if [ -z "${{ secrets.IOS_CERTIFICATE_P12 }}" ]; then
            echo "âš ï¸  WARNING: IOS_CERTIFICATE_P12 secret is empty!"
            echo "     Proceeding without developer certificate (manual signing only)"
          else
            echo "ğŸ“¥ Decoding certificate from secret..."
            if ! echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 -d > ios_cert.p12 2>/dev/null; then
              echo "âŒ Failed to decode certificate"
              exit 1
            fi
            
            if [ ! -f ios_cert.p12 ] || [ ! -s ios_cert.p12 ]; then
              echo "âŒ Certificate file is empty or missing"
              exit 1
            fi
            
            echo "ğŸ” Creating keychain..."
            security create-keychain -p "" build.keychain || true
            security list-keychains -s ~/Library/Keychains/build.keychain
            security unlock-keychain -p "" ~/Library/Keychains/build.keychain
            security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
            
            echo "âœ… Importing certificate to keychain..."
            if security import ios_cert.p12 -k ~/Library/Keychains/build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign; then
              echo "âœ… Certificate imported successfully"
              
              # Make the keychain the default
              security default-keychain -s ~/Library/Keychains/build.keychain
              
              # List the imported identities
              echo ""
              echo "ğŸ“‹ Imported identities:"
              security find-identity -v ~/Library/Keychains/build.keychain || true
            else
              echo "âš ï¸  Warning: Certificate import had issues but continuing..."
            fi
          fi

      # ğŸ“„ Install Provisioning Profile
      - name: ğŸ“„ Install Provisioning Profile
        run: |
          echo "ğŸ“ Setting up provisioning profiles directory..."
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          
          PROFILE_SOURCE="library/MobileDevice/Provisioning Profiles/Digibiz_iOS copy.mobileprovision"
          PROFILE_DEST="$HOME/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision"
      
          if [ ! -f "$PROFILE_SOURCE" ]; then
            echo "âŒ Source profile not found at: $PROFILE_SOURCE"
            exit 1
          fi
          
          echo "ğŸ“‹ Copying provisioning profile from repository..."
          cp "$PROFILE_SOURCE" "$PROFILE_DEST"
          
          # Verify the profile was copied correctly
          if [ ! -f "$PROFILE_DEST" ] || [ ! -s "$PROFILE_DEST" ]; then
            echo "âŒ Failed to copy provisioning profile"
            exit 1
          fi
          
          # Check if it's a valid plist file
          if file "$PROFILE_DEST" | grep -q "bplist"; then
            echo "âœ… Valid binary plist provisioning profile detected"
          elif file "$PROFILE_DEST" | grep -q "XML"; then
            echo "âœ… Valid XML provisioning profile detected"
          else
            echo "âš ï¸  Warning: Profile format may be unexpected"
            file "$PROFILE_DEST"
          fi
          
          echo "âœ… Provisioning profile installed at: $PROFILE_DEST"
          ls -lah "$PROFILE_DEST"

      # ğŸ” Verify Provisioning Profiles
      - name: ğŸ” Verify Provisioning Profiles
        run: |
          echo "ğŸ“‹ Listing all provisioning profiles..."
          PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          
          if [ -d "$PROFILES_DIR" ]; then
            ls -lah "$PROFILES_DIR"
            echo ""
            echo "ğŸ“Š Profile details:"
            for profile in "$PROFILES_DIR"/*.mobileprovision; do
              if [ -f "$profile" ]; then
                echo "  Profile: $(basename "$profile")"
                # Extract UUID if possible
                if command -v security &> /dev/null; then
                  security cms -D -i "$profile" 2>/dev/null | grep -A 1 "UUID" | head -2 || echo "  (Could not extract UUID)"
                fi
              fi
            done
          else
            echo "âš ï¸  Profiles directory not found"
          fi

      # ğŸ—ï¸ Build Archive with Manual Signing
      - name: ğŸ—ï¸  Build Xcode Archive
        run: |
          echo "ğŸ”¨ Building archive with manual signing..."
          mkdir -p output
          
          # Export the keychain path for codesign to find the certificate
          export KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain"
          
          xcodebuild archive \
            -workspace "platforms/ios/${{ env.APP_NAME }}.xcworkspace" \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -derivedDataPath "output/derived" \
            -verbose \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_REQUIRED="YES" \
            CODE_SIGN_IDENTITY="iPhone Developer" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="${{ env.TEAM_ID }}" \
            CURRENT_PROJECT_VERSION="${{ env.PROJECT_VERSION }}"
          
          echo "âœ… Archive created successfully"

      # ğŸ“¤ Export IPA
      - name: ğŸ“¤ Export IPA
        run: |
          echo "ğŸ“¦ Exporting IPA..."
          mkdir -p output/ipa
          
          xcodebuild -exportArchive \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "output/ipa/" \
            -allowProvisioningUpdates
          
          echo "âœ… IPA exported successfully"
          ls -lah output/ipa/

      # ğŸ“Š Verify build artifacts
      - name: ğŸ“Š Verify Build Artifacts
        run: |
          echo "ğŸ” Checking for IPA file..."
          if [ -f "output/ipa/"*.ipa ]; then
              echo "âœ… IPA file found:"
              ls -lah "output/ipa/"*.ipa
          else
              echo "âŒ No IPA file found!"
              exit 1
          fi

      # ğŸ§¹ Cleanup (Always run)
      - name: ğŸ§¹ Cleanup Sensitive Files
        if: always()
        run: |
          echo "ğŸ—‘ï¸  Cleaning up sensitive files..."
          security delete-keychain build.keychain || true
          rm -f ios_cert.p12 || true
          rm -rf "$HOME/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision" || true
          echo "âœ… Cleanup complete"

      # ğŸ“¤ Upload Artifacts
      - name: ğŸ“¤ Upload IPA Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ github.run_number }}
          path: output/ipa/*.ipa
          retention-days: 30

      # ğŸ“ Upload Build Logs
      - name: ğŸ“ Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            output/derived/Logs/Build/*.log
            output/derived/Logs/*.log
          retention-days: 7
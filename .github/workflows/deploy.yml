name: Build iOS Cordova App (Using build.json)

on:
  push:
    branches:
      - main

env:
  APP_NAME: "Digibiz"
  # Cordova iOS versions often use the same version number for the project version
  PROJECT_VERSION: 3080 
  TEAM_ID: Z6XW557ZX2 
  PROFILE_NAME: "Digibiz iOS" # Used as the provisioningProfile in build.json

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Environment âš™ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Cordova CLI and dependencies
        run: |
          npm install -g cordova@11
          npm ci

      - name: Add and Prepare iOS platform
        run: |
          # ðŸ§¹ Ensures a clean project rebuild before adding platform
          rm -rf platforms/ios || true
          
          # Adds the platform
          cordova platform add ios@6.2.0
          
          chmod -R +x platforms/ios/cordova

      
      - name: Generate build.json for Manual Signing ðŸ“„
        id: generate_build_config
        run: |
          # Create build.json file for Cordova to handle manual signing flags automatically
          echo '
          {
            "ios": {
              "release": {
                "developmentTeam": "${{ env.TEAM_ID }}",
                "codeSignIdentity": "iPhone Developer",
                "packageType": "development",
                "provisioningProfile": "${{ env.PROFILE_NAME }}"
              }
            }
          }
          ' > build.json
          echo "Created build.json:"
          cat build.json

      # 1. ðŸ”‘ Manual Signing: Import Certificate (P12)
      - name: ðŸ”‘ Import iOS Certificate (P12)
        run: |
          echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 --decode > ios_cert.p12
          security create-keychain -p "" build.keychain
          security list-keychains -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "" ~/Library/Keychains/build.keychain
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
          security import ios_cert.p12 -k ~/Library/Keychains/build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign

      # 2. ðŸ“„ Manual Signing: Install Provisioning Profile
      - name: ðŸ“„ Install Provisioning Profile
        run: |
          mkdir -p "~/Library/MobileDevice/Provisioning Profiles"
          echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > "~/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision"
          
      
      # 3. ðŸ“¦ Cordova Build & Archive (Uses build.json)
      - name: ðŸ“¦ Cordova Build iOS (Archive)
        run: |
          # Cordova builds the app using the 'release' configuration defined in build.json.
          # The PROJECT_VERSION is still passed as a build flag.
          cordova build ios \
            --device \
            --release \
            --buildConfig=build.json \
            --buildFlag="CURRENT_PROJECT_VERSION=${{ env.PROJECT_VERSION }}"

      # 4. ðŸ“¤ Export IPA (Finds and exports the archive)
      - name: ðŸ“¤ Export IPA (Final Sign)
        id: export_ipa
        run: |
          mkdir -p output/ipa
          # Find the latest generated .xcarchive in the standard DerivedData location
          ARCHIVE_PATH=$(find ~/Library/Developer/Xcode/DerivedData/ -name "*.xcarchive" -depth 2 -type d -print -quit)
          
          if [ -z "$ARCHIVE_PATH" ]; then
            echo "Error: Could not find .xcarchive file after cordova build."
            exit 1
          fi
          
          echo "Found Archive Path: $ARCHIVE_PATH"
          
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath output/ipa/

      

      # 5. ðŸ§¹ Cleanup Keychain and Files
      - name: ðŸ§¹ Cleanup Keychain and Files
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm ios_cert.p12 || true
          rm build.json || true
          rm "~/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision" || true

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: output/ipa/*.ipa
name: üöÄ Cordova iOS Production Build (FINAL FIX)

on:
  push:
    branches:
      - main

env:
  APP_NAME: "Digibiz"
  PROJECT_VERSION: 3080 
  TEAM_ID: Z6XW557ZX2 
  PROFILE_NAME: "Digibiz iOS"
  # Set Node 20 required for modern npm packages.
  NODE_VERSION: 20
  # Use iOS platform v7.x to automatically raise the deployment target.
  IOS_PLATFORM_VERSION: 7.0.0 

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: üîç Checkout repository
        uses: actions/checkout@v4

      # üõ†Ô∏è Setup Node.js v20
      - name: üõ†Ô∏è Setup Node.js (v${{ env.NODE_VERSION }})
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Install npm dependencies
        run: npm ci

      # üîë Install Cordova CLI 12 (Forced and verified)
      - name: üîë Install Cordova CLI 12
        run: |
          npm install -g cordova@12 --force
          cordova -v
          if ! cordova -v | grep -q "12"; then exit 1; fi

      # üü¢ FIX 1: Clean and Prepare iOS platform (Using newer version)
      - name: üì± Clean & Add iOS platform v${{ env.IOS_PLATFORM_VERSION }}
        run: |
          rm -rf platforms/ios || true
          rm -rf plugins || true
          
          # Add the newer platform
          cordova platform add ios@${{ env.IOS_PLATFORM_VERSION }}
          
          # This should run 'pod install' via a Cordova hook
          cordova prepare ios
          
          chmod -R +x platforms/ios/cordova

      # üîë Import Certificate (P12) - Unchanged signing logic
      - name: üîë Import iOS Certificate
        run: |
          # ... (Unchanged steps for importing certificate to keychain) ...
          if [ -z "${{ secrets.IOS_CERTIFICATE_P12 }}" ]; then exit 1; fi
          if ! echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 -d > ios_cert.p12 2>/dev/null; then exit 1; fi
          security create-keychain -p "" build.keychain || true
          security list-keychains -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "" ~/Library/Keychains/build.keychain
          security import ios_cert.p12 -k ~/Library/Keychains/build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security default-keychain -s ~/Library/Keychains/build.keychain
          security find-identity -v ~/Library/Keychains/build.keychain || true

      # üìÑ Install Provisioning Profile - Unchanged signing logic
      - name: üìÑ Install Provisioning Profile
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          PROFILE_DEST="$HOME/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision"
          if ! echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > "$PROFILE_DEST" 2>/dev/null; then exit 1; fi

      # üèóÔ∏è Build Archive with Manual Signing
      - name: üèóÔ∏è  Build Xcode Archive
        run: |
          echo "üî® Building archive with manual signing..."
          mkdir -p output
          export KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain"
          
          # üü¢ CRITICAL FIX 2: CHANGE WORKSPACE NAME TO 'App.xcworkspace'
          # Based on your error, the project name is 'App' not 'Digibiz' inside platforms/ios.
          xcodebuild archive \
            -workspace "platforms/ios/App.xcworkspace" \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -derivedDataPath "output/derived" \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_REQUIRED="YES" \
            CODE_SIGN_IDENTITY="iPhone Developer" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="${{ env.TEAM_ID }}" \
            CURRENT_PROJECT_VERSION="${{ env.PROJECT_VERSION }}"
          
          echo "‚úÖ Archive created successfully"

      # üì§ Export IPA - Unchanged
      - name: üì§ Export IPA
        run: |
          mkdir -p output/ipa
          xcodebuild -exportArchive \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "output/ipa/" \
            -allowProvisioningUpdates
          echo "‚úÖ IPA exported successfully"

      # üßπ Cleanup & Upload Artifacts - Unchanged
      - name: üßπ Cleanup Sensitive Files
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm -f ios_cert.p12 || true
          rm -rf "$HOME/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision" || true
      - name: üì§ Upload IPA Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-final-${{ github.run_number }}
          path: output/ipa/*.ipa
          retention-days: 30
name: Build iOS Cordova App (Manual Signing - Fixed Versions)

on:
  push:
    branches:
      - main

env:
  APP_NAME: "Digibiz"
  PROJECT_VERSION: 3080 
  TEAM_ID: Z6XW557ZX2 
  PROFILE_NAME: "Digibiz iOS"
  # ğŸŸ¢ FIX 1: Change to Node 20 to satisfy modern Firebase plugin requirements (npm warn EBADENGINE)
  NODE_VERSION: 20
  # ğŸŸ¢ FIX 3: Define a newer iOS platform version to resolve the iOS Deployment Target warning (e.g., 11.0 too old)
  IOS_PLATFORM_VERSION: 7.0.0 

jobs:
  build_ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸŸ¢ FIX 1: Setup Node.js v20
      - name: Setup Node.js (v${{ env.NODE_VERSION }})
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ğŸŸ¢ FIX 2: Force Install Cordova CLI v12 (and verify)
      - name: ğŸ”‘ Install Cordova CLI (Forced)
        run: |
          echo "Installing Cordova 12 globally with force..."
          # Use --force to bypass cache and ensure the correct version installs
          npm install -g cordova@12 --force
          
          echo "Verifying Cordova version..."
          cordova -v
          
          # Check for the correct version and fail the build if it's wrong
          if ! cordova -v | grep -q "12"; then
            echo "âŒ ERROR: Cordova 12 installation failed or wrong version is in PATH."
            exit 1
          fi

      # ğŸŸ¢ FIX 3: Prepare iOS platform (Use newer version)
      - name: Prepare iOS platform (Clean rebuild)
        run: |
          echo "ğŸ”„ Removing old iOS platform..."
          rm -rf platforms/ios || true
          rm -rf plugins || true
          
          echo "ğŸ“± Adding iOS platform (version ${{ env.IOS_PLATFORM_VERSION }})..."
          # Use the newer platform version to fix the deployment target warning and plugin compatibility
          cordova platform add ios@${{ env.IOS_PLATFORM_VERSION }}
          
          echo "ğŸ“¦ Installing Cordova plugins..."
          cordova prepare ios
          
          echo "âœ… Setting execute permissions on cordova tools..."
          chmod -R +x platforms/ios/cordova

      # ğŸ”‘ Import Certificate (P12) - Unchanged, relies on secrets
      - name: ğŸ”‘ Import iOS Certificate
        run: |
          echo "ğŸ“¦ Preparing certificate for import..."
          
          if [ -z "${{ secrets.IOS_CERTIFICATE_P12 }}" ]; then
            echo "âš ï¸  WARNING: IOS_CERTIFICATE_P12 secret is empty!"
            echo "     Proceeding without developer certificate (manual signing only)"
          else
            echo "ğŸ“¥ Decoding certificate from secret..."
            if ! echo "${{ secrets.IOS_CERTIFICATE_P12 }}" | base64 -d > ios_cert.p12 2>/dev/null; then
              echo "âŒ Failed to decode certificate"
              exit 1
            fi
            
            if [ ! -f ios_cert.p12 ] || [ ! -s ios_cert.p12 ]; then
              echo "âŒ Certificate file is empty or missing"
              exit 1
            fi
            
            echo "ğŸ” Creating keychain..."
            security create-keychain -p "" build.keychain || true
            security list-keychains -s ~/Library/Keychains/build.keychain
            security unlock-keychain -p "" ~/Library/Keychains/build.keychain
            security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
            
            echo "âœ… Importing certificate to keychain..."
            if security import ios_cert.p12 -k ~/Library/Keychains/build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign; then
              echo "âœ… Certificate imported successfully"
              security default-keychain -s ~/Library/Keychains/build.keychain
              echo ""
              echo "ğŸ“‹ Imported identities:"
              security find-identity -v ~/Library/Keychains/build.keychain || true
            else
              echo "âš ï¸  Warning: Certificate import had issues but continuing..."
            fi
          fi

      # ğŸŸ¢ FIX 4: Install Provisioning Profile (Use base64 decode from secret)
      - name: ğŸ“„ Install Provisioning Profile
        run: |
          echo "ğŸ“ Setting up provisioning profiles directory..."
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          
          PROFILE_DEST="$HOME/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision"
          
          echo "ğŸ“¥ Decoding profile from secret..."
          # This uses the secret which was successful in your log (base64 decoding)
          if ! echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > "$PROFILE_DEST" 2>/dev/null; then
            echo "âŒ Failed to decode provisioning profile"
            exit 1
          fi
          
          echo "âœ… Provisioning profile installed at: $PROFILE_DEST"
          ls -lah "$PROFILE_DEST"

      # ğŸ” Verify Provisioning Profiles - Unchanged
      - name: ğŸ” Verify Provisioning Profiles
        run: |
          echo "ğŸ“‹ Listing all provisioning profiles..."
          PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          
          if [ -d "$PROFILES_DIR" ]; then
            ls -lah "$PROFILES_DIR"
            echo ""
            echo "ğŸ“Š Profile details:"
            for profile in "$PROFILES_DIR"/*.mobileprovision; do
              if [ -f "$profile" ]; then
                echo "  Profile: $(basename "$profile")"
                if command -v security &> /dev/null; then
                  security cms -D -i "$profile" 2>/dev/null | grep -A 1 "UUID" | head -2 || echo "  (Could not extract UUID)"
                fi
              fi
            done
          else
            echo "âš ï¸  Profiles directory not found"
          fi

      # ğŸ—ï¸ Build Archive with Manual Signing - Unchanged
      - name: ğŸ—ï¸  Build Xcode Archive
        run: |
          echo "ğŸ”¨ Building archive with manual signing..."
          mkdir -p output
          
          export KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain"
          
          xcodebuild archive \
            -workspace "platforms/ios/${{ env.APP_NAME }}.xcworkspace" \
            -scheme "${{ env.APP_NAME }}" \
            -configuration Release \
            -destination "generic/platform=iOS" \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -derivedDataPath "output/derived" \
            -verbose \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_REQUIRED="YES" \
            CODE_SIGN_IDENTITY="iPhone Developer" \
            PROVISIONING_PROFILE_SPECIFIER="${{ env.PROFILE_NAME }}" \
            DEVELOPMENT_TEAM="${{ env.TEAM_ID }}" \
            CURRENT_PROJECT_VERSION="${{ env.PROJECT_VERSION }}"
          
          echo "âœ… Archive created successfully"

      # ğŸ“¤ Export IPA - Unchanged
      - name: ğŸ“¤ Export IPA
        run: |
          echo "ğŸ“¦ Exporting IPA..."
          mkdir -p output/ipa
          
          xcodebuild -exportArchive \
            -archivePath "output/${{ env.APP_NAME }}.xcarchive" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "output/ipa/" \
            -allowProvisioningUpdates
          
          echo "âœ… IPA exported successfully"
          ls -lah output/ipa/

      # ğŸ“Š Verify build artifacts - Unchanged
      - name: ğŸ“Š Verify Build Artifacts
        run: |
          echo "ğŸ” Checking for IPA file..."
          if [ -f "output/ipa/"*.ipa ]; then
              echo "âœ… IPA file found:"
              ls -lah "output/ipa/"*.ipa
          else
              echo "âŒ No IPA file found!"
              exit 1
          fi

      # ğŸ§¹ Cleanup (Always run) - Unchanged
      - name: ğŸ§¹ Cleanup Sensitive Files
        if: always()
        run: |
          echo "ğŸ—‘ï¸  Cleaning up sensitive files..."
          security delete-keychain build.keychain || true
          rm -f ios_cert.p12 || true
          rm -rf "$HOME/Library/MobileDevice/Provisioning Profiles/${{ env.PROFILE_NAME }}.mobileprovision" || true
          echo "âœ… Cleanup complete"

      # ğŸ“¤ Upload Artifacts - Unchanged
      - name: ğŸ“¤ Upload IPA Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ github.run_number }}
          path: output/ipa/*.ipa
          retention-days: 30

      # ğŸ“ Upload Build Logs - Unchanged
      - name: ğŸ“ Upload Build Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: |
            output/derived/Logs/Build/*.log
            output/derived/Logs/*.log
          retention-days: 7